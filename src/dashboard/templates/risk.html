{% extends "base.html" %}
{% block title %}风控面板{% endblock %}
{% block page_title %}风控面板{% endblock %}

{% block content %}
<div class="space-y-6" x-data="riskPage()" x-init="init()">

  <!-- 风控状态概览 -->
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
    <div class="card py-3">
      <p class="stat-label">熔断状态</p>
      <p class="stat-value"
         :class="circuitBreaker === 'normal' ? 'text-up' : 'text-down'"
         x-text="circuitBreaker === 'normal' ? '正常' : '已触发'">正常</p>
    </div>
    <div class="card py-3">
      <p class="stat-label">风控规则</p>
      <p class="stat-value text-brand-500" x-text="rulesActive + '/' + rulesTotal">0/0</p>
    </div>
    <div class="card py-3">
      <p class="stat-label">日回撤</p>
      <p class="stat-value" :class="dailyDrawdown > drawdownLimit * 0.7 ? 'text-down' : 'text-up'"
         x-text="dailyDrawdown.toFixed(2) + '%'">0%</p>
    </div>
    <div class="card py-3">
      <p class="stat-label">持仓比例</p>
      <p class="stat-value text-yellow-400" x-text="positionRatio.toFixed(1) + '%'">0%</p>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- 风控规则列表 -->
    <div class="card">
      <h3 class="text-sm font-semibold text-gray-300 mb-4">风控规则</h3>
      <div class="space-y-3">
        <template x-for="r in rules" :key="r.name">
          <div class="flex items-center justify-between p-3 rounded-lg bg-surface-3/50 border border-gray-700/30">
            <div class="flex items-center space-x-3">
              <span class="w-2 h-2 rounded-full" :class="r.enabled ? 'bg-green-500' : 'bg-gray-600'"></span>
              <div>
                <p class="text-sm text-white" x-text="r.name"></p>
                <p class="text-xs text-gray-500" x-text="r.description || r.type"></p>
              </div>
            </div>
            <div class="flex items-center space-x-3">
              <span class="text-xs font-mono text-gray-400" x-text="r.current !== undefined ? r.current : '-'"></span>
              <span class="text-xs text-gray-500">/</span>
              <span class="text-xs font-mono text-yellow-400" x-text="r.limit !== undefined ? r.limit : '-'"></span>
              <span class="text-xs px-2 py-0.5 rounded"
                    :class="r.triggered ? 'bg-red-500/20 text-red-400' : 'bg-green-500/10 text-green-400'"
                    x-text="r.triggered ? '触发' : '正常'"></span>
            </div>
          </div>
        </template>
        <template x-if="rules.length === 0">
          <p class="text-gray-500 text-sm text-center py-4">暂无风控规则</p>
        </template>
      </div>
    </div>

    <!-- 风控告警历史 -->
    <div class="card">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-sm font-semibold text-gray-300">告警历史</h3>
        <button class="btn btn-outline text-xs" @click="loadAlerts()">刷新</button>
      </div>
      <div class="space-y-2 max-h-96 overflow-y-auto">
        <template x-for="a in alerts" :key="a.timestamp">
          <div class="flex items-start space-x-3 p-2 rounded bg-surface-3/30">
            <span class="mt-0.5 w-2 h-2 rounded-full flex-shrink-0"
                  :class="a.level === 'critical' ? 'bg-red-500' : a.level === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'"></span>
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between">
                <p class="text-xs font-medium" :class="a.level === 'critical' ? 'text-red-400' : 'text-gray-300'" x-text="a.title || a.rule"></p>
                <span class="text-xs text-gray-500 flex-shrink-0 ml-2" x-text="a.timestamp ? new Date(a.timestamp * 1000).toLocaleString('zh-CN') : ''"></span>
              </div>
              <p class="text-xs text-gray-500 truncate" x-text="a.message || a.detail || ''"></p>
            </div>
          </div>
        </template>
        <template x-if="alerts.length === 0">
          <p class="text-gray-500 text-sm text-center py-4">暂无告警</p>
        </template>
      </div>
    </div>
  </div>

  <!-- 回撤监控 -->
  <div class="card">
    <h3 class="text-sm font-semibold text-gray-300 mb-4">风险指标监控</h3>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="p-3 rounded-lg bg-surface-3/30">
        <p class="text-xs text-gray-500 mb-1">最大日回撤限制</p>
        <p class="text-lg font-bold text-white" x-text="drawdownLimit.toFixed(1) + '%'">5%</p>
        <div class="mt-2 h-1.5 bg-gray-700 rounded-full overflow-hidden">
          <div class="h-full rounded-full transition-all"
               :class="dailyDrawdown / drawdownLimit > 0.7 ? 'bg-red-500' : 'bg-green-500'"
               :style="`width: ${Math.min(dailyDrawdown / drawdownLimit * 100, 100)}%`"></div>
        </div>
      </div>
      <div class="p-3 rounded-lg bg-surface-3/30">
        <p class="text-xs text-gray-500 mb-1">最大持仓限制</p>
        <p class="text-lg font-bold text-white" x-text="positionLimit + ' USDC'"></p>
        <div class="mt-2 h-1.5 bg-gray-700 rounded-full overflow-hidden">
          <div class="h-full bg-brand-500 rounded-full transition-all"
               :style="`width: ${positionLimit > 0 ? Math.min(currentPosition / positionLimit * 100, 100) : 0}%`"></div>
        </div>
      </div>
      <div class="p-3 rounded-lg bg-surface-3/30">
        <p class="text-xs text-gray-500 mb-1">日最大亏损</p>
        <p class="text-lg font-bold" :class="dailyLoss > maxDailyLoss * 0.7 ? 'text-down' : 'text-white'"
           x-text="formatUSD(dailyLoss)">$0</p>
      </div>
      <div class="p-3 rounded-lg bg-surface-3/30">
        <p class="text-xs text-gray-500 mb-1">连续亏损次数</p>
        <p class="text-lg font-bold" :class="consecutiveLosses >= maxConsecutiveLosses ? 'text-down' : 'text-white'"
           x-text="consecutiveLosses + ' / ' + maxConsecutiveLosses">0 / 5</p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function riskPage() {
  return {
    circuitBreaker: 'normal', rulesActive: 0, rulesTotal: 0,
    dailyDrawdown: 0, drawdownLimit: 5, positionRatio: 0,
    positionLimit: 500, currentPosition: 0,
    dailyLoss: 0, maxDailyLoss: 50,
    consecutiveLosses: 0, maxConsecutiveLosses: 5,
    rules: [], alerts: [],

    async init() {
      await Promise.all([this.loadRisk(), this.loadAlerts()]);
      window.addEventListener('dash:risk', (e) => {
        const d = e.detail.data;
        if (d.circuit_breaker) this.circuitBreaker = d.circuit_breaker;
        if (d.daily_drawdown !== undefined) this.dailyDrawdown = d.daily_drawdown;
      });
    },

    async loadRisk() {
      try {
        const resp = await fetch('/api/v1/risk');
        const data = await resp.json();
        this.circuitBreaker = data.circuit_breaker || 'normal';
        this.dailyDrawdown = data.daily_drawdown || 0;
        this.drawdownLimit = data.drawdown_limit || 5;
        this.positionRatio = data.position_ratio || 0;
        this.positionLimit = data.position_limit || 500;
        this.currentPosition = data.current_position || 0;
        this.dailyLoss = data.daily_loss || 0;
        this.maxDailyLoss = data.max_daily_loss || 50;
        this.consecutiveLosses = data.consecutive_losses || 0;
        this.maxConsecutiveLosses = data.max_consecutive_losses || 5;
        this.rules = data.rules || [];
        this.rulesTotal = this.rules.length;
        this.rulesActive = this.rules.filter(r => r.enabled).length;
      } catch (e) {}
    },

    async loadAlerts() {
      try {
        const resp = await fetch('/api/v1/alerts');
        const data = await resp.json();
        this.alerts = data.alerts || [];
      } catch (e) {}
    },
  };
}
</script>
{% endblock %}
