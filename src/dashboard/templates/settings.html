{% extends "base.html" %}
{% block title %}系统设置{% endblock %}
{% block page_title %}系统设置{% endblock %}

{% block content %}
<div class="space-y-6" x-data="settingsPage()" x-init="init()">

  <!-- 保存状态提示 -->
  <div x-show="saveMsg" x-transition class="fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-sm"
       :class="saveOk ? 'bg-green-500/20 text-green-400 border border-green-500/30' : 'bg-red-500/20 text-red-400 border border-red-500/30'"
       x-text="saveMsg"></div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

    <!-- 数据源配置 -->
    <div class="card">
      <h3 class="text-sm font-semibold text-gray-300 mb-4">数据源配置</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-xs text-gray-500 mb-1">Chainlink 模式</label>
          <select x-model="cfg.chainlink_mode"
                  class="w-full bg-surface-3 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:border-brand-500 focus:outline-none">
            <option value="auto">自动 (RTDS → Streams → Binance → 链上)</option>
            <option value="rtds">仅 PM RTDS</option>
            <option value="streams">仅 Data Streams</option>
            <option value="binance">仅 Binance</option>
            <option value="onchain">仅链上</option>
          </select>
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1">Chainlink Client ID</label>
          <input type="text" x-model="cfg.chainlink_client_id" placeholder="留空则使用环境变量"
                 class="w-full bg-surface-3 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:border-brand-500 focus:outline-none">
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1">Chainlink Client Secret</label>
          <input type="password" x-model="cfg.chainlink_client_secret" placeholder="留空则使用环境变量"
                 class="w-full bg-surface-3 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:border-brand-500 focus:outline-none">
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1">价格刷新间隔 (秒)</label>
          <input type="number" x-model.number="cfg.price_interval" min="1" max="60"
                 class="w-full bg-surface-3 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:border-brand-500 focus:outline-none">
        </div>
      </div>
    </div>

    <!-- 交易配置 -->
    <div class="card">
      <h3 class="text-sm font-semibold text-gray-300 mb-4">交易配置</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-xs text-gray-500 mb-1">交易模式</label>
          <select x-model="cfg.trading_mode"
                  class="w-full bg-surface-3 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:border-brand-500 focus:outline-none">
            <option value="paper">模拟交易 (Paper)</option>
            <option value="live">实盘交易 (Live)</option>
          </select>
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1">默认仓位大小 (USDC)</label>
          <input type="number" x-model.number="cfg.default_position_size" min="1" step="1"
                 class="w-full bg-surface-3 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:border-brand-500 focus:outline-none">
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1">最大并行仓位</label>
          <input type="number" x-model.number="cfg.max_positions" min="1" max="20"
                 class="w-full bg-surface-3 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:border-brand-500 focus:outline-none">
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1">滑点容忍度 (%)</label>
          <input type="number" x-model.number="cfg.slippage_tolerance" min="0" max="5" step="0.1"
                 class="w-full bg-surface-3 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:border-brand-500 focus:outline-none">
        </div>
      </div>
    </div>

    <!-- 风控阈值 -->
    <div class="card">
      <h3 class="text-sm font-semibold text-gray-300 mb-4">风控阈值</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-xs text-gray-500 mb-1">最大日回撤 (%)</label>
          <input type="number" x-model.number="cfg.max_daily_drawdown" min="0.5" max="20" step="0.5"
                 class="w-full bg-surface-3 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:border-brand-500 focus:outline-none">
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1">最大日亏损 (USDC)</label>
          <input type="number" x-model.number="cfg.max_daily_loss" min="1" step="1"
                 class="w-full bg-surface-3 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:border-brand-500 focus:outline-none">
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1">最大连续亏损次数</label>
          <input type="number" x-model.number="cfg.max_consecutive_losses" min="1" max="20"
                 class="w-full bg-surface-3 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:border-brand-500 focus:outline-none">
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1">最大持仓限额 (USDC)</label>
          <input type="number" x-model.number="cfg.max_position_limit" min="10" step="10"
                 class="w-full bg-surface-3 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:border-brand-500 focus:outline-none">
        </div>
      </div>
    </div>

    <!-- 通知配置 -->
    <div class="card">
      <h3 class="text-sm font-semibold text-gray-300 mb-4">通知配置</h3>
      <div class="space-y-4">
        <div class="flex items-center justify-between">
          <label class="text-sm text-gray-400">Dashboard 弹窗通知</label>
          <button class="relative w-10 h-5 rounded-full transition-colors"
                  :class="cfg.notify_dashboard ? 'bg-brand-500' : 'bg-gray-600'"
                  @click="cfg.notify_dashboard = !cfg.notify_dashboard">
            <span class="absolute top-0.5 left-0.5 w-4 h-4 rounded-full bg-white transition-transform"
                  :class="cfg.notify_dashboard ? 'translate-x-5' : ''"></span>
          </button>
        </div>
        <div class="flex items-center justify-between">
          <label class="text-sm text-gray-400">风控告警通知</label>
          <button class="relative w-10 h-5 rounded-full transition-colors"
                  :class="cfg.notify_risk ? 'bg-brand-500' : 'bg-gray-600'"
                  @click="cfg.notify_risk = !cfg.notify_risk">
            <span class="absolute top-0.5 left-0.5 w-4 h-4 rounded-full bg-white transition-transform"
                  :class="cfg.notify_risk ? 'translate-x-5' : ''"></span>
          </button>
        </div>
        <div class="flex items-center justify-between">
          <label class="text-sm text-gray-400">交易执行通知</label>
          <button class="relative w-10 h-5 rounded-full transition-colors"
                  :class="cfg.notify_trades ? 'bg-brand-500' : 'bg-gray-600'"
                  @click="cfg.notify_trades = !cfg.notify_trades">
            <span class="absolute top-0.5 left-0.5 w-4 h-4 rounded-full bg-white transition-transform"
                  :class="cfg.notify_trades ? 'translate-x-5' : ''"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 保存按钮 -->
  <div class="flex justify-end space-x-3">
    <button class="btn btn-outline" @click="load()">重置</button>
    <button class="px-6 py-2 rounded-lg bg-brand-500 hover:bg-brand-600 text-white text-sm font-medium transition-colors"
            @click="save()">保存设置</button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function settingsPage() {
  return {
    saveMsg: '', saveOk: true,
    cfg: {
      chainlink_mode: 'auto',
      chainlink_client_id: '',
      chainlink_client_secret: '',
      price_interval: 5,
      trading_mode: 'paper',
      default_position_size: 10,
      max_positions: 5,
      slippage_tolerance: 0.5,
      max_daily_drawdown: 5,
      max_daily_loss: 50,
      max_consecutive_losses: 5,
      max_position_limit: 500,
      notify_dashboard: true,
      notify_risk: true,
      notify_trades: true,
    },

    async init() { await this.load(); },

    async load() {
      try {
        const resp = await fetch('/api/v1/settings');
        const data = await resp.json();
        if (data.settings) Object.assign(this.cfg, data.settings);
      } catch (e) {}
    },

    async save() {
      try {
        const resp = await fetch('/api/v1/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(this.cfg),
        });
        const data = await resp.json();
        if (data.ok) { this.saveMsg = '设置已保存'; this.saveOk = true; }
        else { this.saveMsg = '保存失败: ' + (data.error || '未知错误'); this.saveOk = false; }
      } catch (e) {
        this.saveMsg = '保存失败: 网络错误'; this.saveOk = false;
      }
      setTimeout(() => this.saveMsg = '', 3000);
    },
  };
}
</script>
{% endblock %}
