{% extends "base.html" %}
{% block title %}总览{% endblock %}
{% block page_title %}总览{% endblock %}

{% block content %}
<div class="space-y-6">

  <!-- ═══ 顶部指标卡片 ═══ -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
    <!-- 账户余额 -->
    <div class="card">
      <div class="flex items-center justify-between">
        <div>
          <p class="stat-label">账户余额</p>
          <p class="stat-value text-white" x-text="formatUSD(balance)">$0.00</p>
        </div>
        <div class="w-10 h-10 rounded-lg bg-brand-600/20 flex items-center justify-center">
          <svg class="w-5 h-5 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </div>
      </div>
    </div>

    <!-- 总权益 -->
    <div class="card">
      <div class="flex items-center justify-between">
        <div>
          <p class="stat-label">总权益</p>
          <p class="stat-value text-white" x-text="formatUSD(equity)">$0.00</p>
        </div>
        <div class="w-10 h-10 rounded-lg bg-green-600/20 flex items-center justify-center">
          <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z"/></svg>
        </div>
      </div>
    </div>

    <!-- 当日 PnL -->
    <div class="card">
      <div class="flex items-center justify-between">
        <div>
          <p class="stat-label">当日盈亏</p>
          <p class="stat-value" :class="dailyPnl >= 0 ? 'text-up' : 'text-down'"
             x-text="formatPnl(dailyPnl)">$0.00</p>
        </div>
        <div class="w-10 h-10 rounded-lg flex items-center justify-center"
             :class="dailyPnl >= 0 ? 'bg-green-600/20' : 'bg-red-600/20'">
          <svg class="w-5 h-5" :class="dailyPnl >= 0 ? 'text-green-400' : 'text-red-400'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941"/></svg>
        </div>
      </div>
    </div>

    <!-- BTC 价格 -->
    <div class="card">
      <div class="flex items-center justify-between">
        <div>
          <p class="stat-label">BTC/USD (Chainlink)</p>
          <p class="stat-value font-mono" :class="priceDirection > 0 ? 'text-up' : priceDirection < 0 ? 'text-down' : 'text-white'"
             x-text="formatUSD(btcPrice)">$0.00</p>
        </div>
        <div class="w-10 h-10 rounded-lg bg-yellow-600/20 flex items-center justify-center">
          <span class="text-yellow-400 font-bold text-sm">₿</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ 中间区域: 价格图 + 系统状态 ═══ -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- 实时价格图 -->
    <div class="lg:col-span-2 card">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-sm font-semibold text-gray-300">BTC/USD 实时价格</h3>
        <span class="badge badge-green">LIVE</span>
      </div>
      <div id="overview-price-chart" style="height: 300px;"></div>
    </div>

    <!-- 系统状态 -->
    <div class="card space-y-4">
      <h3 class="text-sm font-semibold text-gray-300">系统状态</h3>

      <div class="space-y-3">
        <div class="flex justify-between items-center">
          <span class="text-sm text-gray-400">运行模式</span>
          <span class="badge badge-blue">{{ run_mode | upper }}</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-sm text-gray-400">交易模式</span>
          <span class="badge badge-yellow">{{ trading_mode | upper }}</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-sm text-gray-400">运行时间</span>
          <span class="text-sm font-mono text-gray-200" x-text="formatUptime(uptime)">00:00:00</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-sm text-gray-400">WebSocket</span>
          <span class="text-sm" :class="wsConnected ? 'text-up' : 'text-down'"
                x-text="wsConnected ? '已连接' : '断开'">断开</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-sm text-gray-400">初始余额</span>
          <span class="text-sm text-gray-200">{{ "%.2f" | format(account.initial_balance) }} USDC</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-sm text-gray-400">总收益率</span>
          <span class="text-sm font-mono"
                :class="(equity - {{ account.initial_balance }}) >= 0 ? 'text-up' : 'text-down'"
                x-text="((equity - {{ account.initial_balance }}) / {{ account.initial_balance or 1 }} * 100).toFixed(2) + '%'">
            0.00%
          </span>
        </div>
      </div>

      <!-- 快速操作 -->
      <div class="pt-3 border-t border-gray-700/50 space-y-2">
        <a href="/market" class="btn btn-primary w-full text-center block">查看行情</a>
        <a href="/strategy" class="btn btn-outline w-full text-center block">管理策略</a>
      </div>
    </div>
  </div>

  <!-- ═══ 底部: 最近交易 + 最近告警 ═══ -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- 最近交易 -->
    <div class="card">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-sm font-semibold text-gray-300">最近交易</h3>
        <a href="/trades" class="text-xs text-brand-500 hover:underline">查看全部</a>
      </div>
      <div x-data="{ trades: [] }" x-init="
        fetch('/api/v1/trades').then(r=>r.json()).then(d => trades = (d.trades || []).slice(0, 5));
        window.addEventListener('dash:trades', e => {
          trades.unshift(e.detail.data);
          if (trades.length > 5) trades.pop();
        });
      ">
        <template x-if="trades.length === 0">
          <p class="text-sm text-gray-500 text-center py-6">暂无交易记录</p>
        </template>
        <div class="space-y-2">
          <template x-for="t in trades" :key="t.id || Math.random()">
            <div class="flex justify-between items-center text-sm py-1 border-b border-gray-700/30">
              <div>
                <span class="font-medium" :class="t.side === 'buy' ? 'text-up' : 'text-down'" x-text="t.side?.toUpperCase()"></span>
                <span class="text-gray-400 ml-2" x-text="t.market || 'BTC-5min'"></span>
              </div>
              <div class="text-right">
                <span class="font-mono" x-text="'$' + Number(t.amount || 0).toFixed(2)"></span>
                <span class="text-gray-500 ml-2 text-xs" x-text="t.timestamp ? new Date(t.timestamp * 1000).toLocaleTimeString() : ''"></span>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>

    <!-- 最近告警 -->
    <div class="card">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-sm font-semibold text-gray-300">风控告警</h3>
        <a href="/risk" class="text-xs text-brand-500 hover:underline">查看全部</a>
      </div>
      <div x-data="{ alerts: [] }" x-init="
        fetch('/api/v1/alerts').then(r=>r.json()).then(d => alerts = (d.alerts || []).slice(0, 5));
        window.addEventListener('dash:risk', e => {
          alerts.unshift(e.detail.data);
          if (alerts.length > 5) alerts.pop();
        });
      ">
        <template x-if="alerts.length === 0">
          <p class="text-sm text-gray-500 text-center py-6">系统正常，无告警</p>
        </template>
        <div class="space-y-2">
          <template x-for="a in alerts" :key="a.timestamp || Math.random()">
            <div class="flex items-start gap-2 text-sm py-1 border-b border-gray-700/30">
              <span class="badge mt-0.5"
                    :class="a.level?.includes('P0') ? 'badge-red' : a.level?.includes('P1') ? 'badge-red' : a.level?.includes('P2') ? 'badge-yellow' : 'badge-blue'"
                    x-text="a.level || 'INFO'"></span>
              <span class="text-gray-300 flex-1" x-text="a.message"></span>
            </div>
          </template>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('alpine:init', () => {
  // 初始化实时价格折线图
  setTimeout(() => {
    const el = document.getElementById('overview-price-chart');
    if (!el) return;
    const { chart, lineSeries } = createLineChart(el);

    // 收到价格时添加数据点
    const addPoint = throttle((price) => {
      const time = Math.floor(Date.now() / 1000);
      lineSeries.update({ time, value: price });
    }, 1000);

    window.addEventListener('dash:price', (e) => {
      const price = e.detail?.data?.price;
      if (price > 0) addPoint(price);
    });
    window.addEventListener('dash:heartbeat', (e) => {
      const price = e.detail?.data?.btc_price;
      if (price > 0) addPoint(price);
    });

    // 响应窗口大小变化
    new ResizeObserver(() => {
      chart.applyOptions({ width: el.clientWidth });
    }).observe(el);
  }, 300);
});
</script>
{% endblock %}
